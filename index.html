<html>
    <head>
        <title>chowtime</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link href="https://fonts.googleapis.com/css?family=Sniglet:800" rel="stylesheet">
        <link rel="icon" type="image/png" href="donut.png">
        <style>
            .submit {
                width: 200px;
                background-color: #4BA3C3;
                color: white;
                padding: 14px 20px;
                margin: auto;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 24px;
                text-decoration: none;
            }
            body{
                text-align: center;
                font-family: 'Sniglet', cursive;
                margin-top: 50px    ;
            }
            h3{
                margin-top: -30px; 
            }
            a{
                color: black;
            }
            a:visited{
                color: black;
            }
            .badge {
                display: block;

                padding: 0;
                font-size: 30px;
                font-weight: lighter !important;
                line-height: 50px;
                color: #fff !important;
                text-align: center;
                white-space: nowrap;
                vertical-align: baseline;
                background-color: lightgray;
                border-radius:50px;
                position: relative;
                top: -3px;
                height: 50px;
                width: 50px;
                text-decoration: none;
                margin: auto;
                margin-top: 20px;
            }
            #info{
                max-width: 30em;
                margin: auto;
                font-family: sans-serif;
                text-align: left;
            }
            #info h4{
                font-size:30px;
            }
            #info p{
                font-size:20px;
            }
        </style>
    </head>
    <body>
        <div id="eatingDisplay"><img src="chow.svg" width=200px><h1>EATING</h1></div>
        <div id="notEatingDisplay"><img src="unchow.svg" width=200px><h1>NOT EATING</h1></div><br>
        <h3> For <span id="time"></span></h3>
        <a id="eating" onclick="startEating()" class="submit" >Start Eating</a>
        <a id="notEating" onclick="stopEating()" class="submit" style="display:none;"> Stop Eating</a>
        <a href="#" onclick="toggleInfo()" class="badge">?</a>
        <div id="info" style="display:none;">
            <h4>What is Chowtime?</h4>
            <p>Chowtime is a simple web app that can be used to track your eating habits. Just click the button above whenever you start and stop eating. Then export the data and use it however you like. I initially created it to track my efforts in intermittent fasting.</p>
            <h4>How is my data stored?</h4>
            <p>Chowtime uses the browser's local storage. This means that your data never leaves your device and yours to do with as you please. The only downside to this is that localstorage is wiped whenever you delete your local cache/history/app data.</p>
            <h4>How do I export my data?</h4>
            <p>Sure! Click <a href="#" id="link" download="eatingHistory.json">this link</a> here to download the latest data in JSON.</p>
        </div>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
        <script>
            var data = [];
            
            function startEating(){
                showEating();
                storeEating(true);
            }
            
            function stopEating(){
                showNotEating();
                storeEating(false);
            }
            
            function storeEating(isEating){
                data = JSON.parse(localStorage.data);
                var time = new Date().getTime();
                var event = {
                    "time" : time,
                    "eating" : isEating
                };
                data.push(event);
                exportHistory(data);
                localStorage.currentState = isEating;
                localStorage.data = JSON.stringify(data);
            }
            
            function init(){
                if (!localStorage.data){
                    localStorage.data = JSON.stringify([]);
                    stopEating();
                } else {
                    data = JSON.parse(localStorage.data);
                }
                
                    if (localStorage.currentState == "true"){
                        showEating();
                    } else {
                        showNotEating();
                    }
                updateTime();
                exportHistory(data);
                setInterval(updateTime, 1000);
            }
            
            function updateTime(){
                var now  = new Date().getTime();
                var then = data[data.length-1].time;

                var ms = moment(now,"x").diff(moment(then,"x"));
                var d = moment.duration(ms);
                var s = Math.floor(d.asHours()) + moment.utc(ms).format(":mm:ss");
                
                document.getElementById("time").innerHTML = s;
            }
            
            function showEating(){
                document.getElementById("eatingDisplay").style.display = 'block';
                document.getElementById("notEatingDisplay").style.display = 'none';
                document.getElementById("eating").style.display = 'none';
                document.getElementById("notEating").style.display = 'block';
            }
            
            function showNotEating(){
                document.getElementById("eatingDisplay").style.display = 'none';
                document.getElementById("notEatingDisplay").style.display = 'block';
                document.getElementById("notEating").style.display = 'none';
                document.getElementById("eating").style.display = 'block';
            }
            
            function exportHistory(history){
                var str = JSON.stringify(history);
                var dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(str);
                var link = document.getElementById('link').href = dataUri;
            }
            
            function toggleInfo(){
                if(document.getElementById("info").style.display == 'none'){
                    document.getElementById("info").style.display = 'block';
                } else {
                    document.getElementById("info").style.display = 'none';
                }
            }
            
            init();
        </script>
    
    </body>

</html>
